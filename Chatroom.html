<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Rooms - Myle Fanpage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: red;
        }
        input, textarea {
            padding: 10px;
            margin: 10px 0;
            border: 2px solid red;
            border-radius: 5px;
            width: 250px;
        }
        button {
            padding: 10px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: darkred;
        }
        #message {
            margin-top: 20px;
            color: red; /* Fehlernachrichten rot */
        }

        /* Chat Styles */
        .chat-container {
            max-width: 600px; 
            width: 100%;
            margin-top: 20px; 
            display: none; /* Standardmäßig verstecken */
        }
        .message-container {
            display: flex; 
            flex-direction: column; 
            max-height: 300px; 
            overflow-y: auto; /* Scrollbar für Überlauf */
            border-radius: 5px; 
            background-color: rgba(255, 255, 255, 0.1); /* Hintergrundfarbe des Chatfensters */
        }
        .message {
            padding: 10px; 
            border-radius: 20px; 
            margin: 5px; 
            max-width: fit-content; 
            word-wrap: break-word; 
        }
        .from-other {
            background-color: black; /* Hintergrundfarbe für andere Benutzer */
            color: white; /* Textfarbe für andere Benutzer */
            align-self: flex-start; /* Links ausgerichtet */
        }
        .from-me {
            background-color: gray; /* Graue Hintergrundfarbe für eigene Nachrichten */
            color: white; /* Weiße Schriftfarbe für eigene Nachrichten */
            align-self: flex-end; /* Rechts ausgerichtet */
        }

        /* Anmelde-Pop-up Styles */
        .modal {
           display: flex; 
           justify-content: center; 
           align-items: center; 
           position: fixed; 
           top :0 ; 
           left :0 ; 
           width :100%; 
           height :100%; 
           background-color :rgba(0, 0, 0, 0.7); /* Dunkler Hintergrund mit Transparenz */
           z-index :1000; /* Über anderen Inhalten */
       }

       .modal-content {
           background-color :#333; /* Dunkelgrauer Hintergrund für das Modal */
           padding :20px ;
           border-radius :10px ;
           box-shadow :0 0 15px rgba(255,255,255,0.5);
           color:white ; /* Textfarbe im Modal */
           width :300px ; /* Breite des Modals */
           text-align:center ; /* Text zentrieren */
           position:absolute ;
           top :50%;
           left :50%;
           transform :translate(-50%, -50%); /* Zentriere das Modal */
       }

       .modal-content h2 {
           color:red ; /* Rote Überschrift im Modal */
       }

       #chatInput {
           background-color:#444 ; /* Dunkelgrauer Hintergrund für das Eingabefeld */
           color:white ; /* Weiße Schriftfarbe im Eingabefeld */
           border-radius :5px ; /* Abgerundete Ecken */
       }

       #sendChatBtn {
           background-color :#28a745 ; /* Grüner Hintergrund für den Senden-Button */
       }

       #sendChatBtn:hover {
           background-color :#218838 ; /* Dunkler bei Hover */
       }

    </style>
</head>
<body>

<h1>Chat Rooms - Myle Fanpage</h1>

<div id="message"></div>

<!-- Chatbereich -->
<div class="chat-container" id="chatContainer">
    <h2>Chat</h2>
    <div class="message-container" id="messageContainer">
        <!-- Hier werden die Nachrichten angezeigt -->
    </div>
    <textarea id="chatInput" placeholder="Schreibe eine Nachricht..." rows="2"></textarea>
    <button id="sendChatBtn">Nachricht senden</button>
</div>

<!-- Modal für das Login -->
<div id="loginModal" class="modal" style="display:block;">
    <div class="modal-content">
      <h2>Anmelden</h2>
      <input type="text" id="username" placeholder="Benutzername" required>
      <input type="password" id="password" placeholder="Passwort" required>
      <button id="loginBtn">Einloggen</button>
      <button id="registerBtn">Registrieren</button>
      <div id="loginMessage"></div> <!-- Nachricht für Login -->
      <p id="noAccountMessage">Wenn du kein Konto hast, gehe auf das Menü und erstelle einen Account.</p> <!-- Hinweis für neue Benutzer -->
    </div>
</div>

<script type="module">
// Importiere die benötigten Funktionen aus den SDKs
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// Deine Firebase-Konfiguration
const firebaseConfig = {
    apiKey: "AIzaSyC63y4s1JW_zl2FfhPwkrIM2DzcW9LuLjI",
    authDomain: "myle-fanpage-517ce.firebaseapp.com",
    databaseURL: "https://myle-fanpage-517ce-default-rtdb.firebaseio.com",
    projectId: "myle-fanpage-517ce",
    storageBucket: "myle-fanpage-517ce.firebasestorage.app",
    messagingSenderId: "367391290237",
    appId: "1:367391290237:web:9b2f5a1b4fc1d53d495214",
    measurementId: "G-5VGLEV03P6"
};

// Firebase initialisieren
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

// Funktion zur Anzeige von Nachrichten
function showMessage(message, isError) {
    const messageDiv = document.getElementById('loginMessage');
    messageDiv.textContent = message;
    messageDiv.style.color = isError ? 'red' : 'green'; // Fehlernachricht rot, Erfolg grün
}

// Funktion zum Registrieren eines neuen Benutzers
document.getElementById('registerBtn').onclick = function() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    // Eingabefelder überprüfen
    if (!username || !password) {
        showMessage("Bitte fülle alle Felder aus!", true);
        return;
    }

    // Benutzer-ID erstellen (Benutzername verwenden)
    const userId = username;

    // Überprüfen, ob der Benutzer bereits existiert
    const dbRef = ref(database);
    get(child(dbRef, 'users/' + userId)).then((snapshot) => {
        if (snapshot.exists()) {
            showMessage("Benutzer existiert bereits!", true);
        } else {
            // Benutzer in der Datenbank speichern
            set(ref(database, 'users/' + userId), { username, password })
                .then(() => {
                    showMessage("Registrierung erfolgreich! Du kannst dich jetzt einloggen.", false);
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                })
                .catch((error) => {
                    console.error("Fehler beim Speichern der Daten:", error);
                    showMessage("Ein Fehler ist aufgetreten!", true);
                });
        }
    }).catch((error) => {
        console.error("Fehler beim Überprüfen der Benutzerdaten:", error);
        showMessage("Ein Fehler ist aufgetreten!", true);
    });
};

// Funktion zum Einloggen
document.getElementById('loginBtn').onclick = function() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    // Eingabefelder überprüfen
    if (!username || !password) {
        showMessage("Bitte fülle alle Felder aus!", true);
        return;
    }

    // Benutzerdaten abrufen und überprüfen
    const dbRef = ref(database);
    get(child(dbRef, 'users')).then((snapshot) => {
        if (snapshot.exists()) {
            let userFound = false;

            snapshot.forEach((childSnapshot) => {
                const userData = childSnapshot.val();
                if (userData.username === username && userData.password === password) {
                    userFound = true; // Benutzer gefunden
                    localStorage.setItem('username', username); // Speichere Benutzernamen im Local Storage
                    showMessage("Login erfolgreich!", false);

                    document.getElementById('loginModal').style.display = 'none'; // Schließe das Modal nach erfolgreichem Login

                    // Zeige den Chatbereich an
                    document.getElementById('chatContainer').style.display = 'block'; 

                    loadChatMessages(); // Lade Chatnachrichten nach dem Einloggen
                }
            });

            if (!userFound) {
                showMessage("Ungültige Anmeldedaten!", true);
            }
        } else {
            showMessage("Keine Benutzerdaten gefunden!", true);
        }
    }).catch((error) => {
        console.error("Fehler beim Abrufen der Daten:", error);
        showMessage("Ein Fehler ist aufgetreten!", true);
    });
};

// Funktion zum Senden einer Chatnachricht (Kommentar)
document.getElementById('sendChatBtn').onclick = function() {
   const chatInputValue = document.getElementById('chatInput').value.trim();

   if (!chatInputValue) { 
       showMessage("Bitte schreibe eine Nachricht!", true); 
       return; 
   }

   const username = localStorage.getItem('username'); 

   if (!username) { 
       showMessage("Bitte melde dich an, um eine Nachricht zu senden.", true); 
       return; 
   }

   const commentId = Date.now(); 

   set(ref(database, `comments/${commentId}`), { 
       username,
       commentText : chatInputValue,
       isVerified : true,
       timestamp : commentId,
   }).then(() => { 
       document.getElementById('chatInput').value = ''; 
       loadChatMessages(); // Lade die Chatnachrichten neu nach dem Senden.
   }).catch((error) => { 
       console.error("Fehler beim Speichern der Kommentar:", error); 
       showMessage("Ein Fehler ist aufgetreten!", true); 
   });
};

// Lade die Chatnachrichten beim Laden der Seite und überprüfe den Anmeldestatus
window.onload = function() {
   const username = localStorage.getItem('username');
   if (!username) { 
       document.getElementById('noAccountMessage').style.display = 'block'; // Zeige Hinweis für neue Benutzer an
   } else { 
       loadChatMessages(); // Lade die Chatnachrichten beim Laden der Seite.
   }
};

// Funktion zum Laden der Chatnachrichten
function loadChatMessages() {
   const dbRef = ref(database);
   get(child(dbRef, 'comments')).then((snapshot) => {
       if (snapshot.exists()) {
           const messageContainer = document.getElementById('messageContainer');
           messageContainer.innerHTML = ''; // Leere den Container vor dem Laden neuer Nachrichten

           snapshot.forEach((childSnapshot) => {
               const data = childSnapshot.val();
               const messageDiv = document.createElement('div');
               messageDiv.className = data.username === localStorage.getItem('username') ? 'message from-me' : 'message from-other';
               messageDiv.textContent = data.username !== localStorage.getItem('username') ? `${data.username}: ${data.commentText}` : data.commentText; // Zeige nur den Text ohne Benutzernamen für eigene Nachrichten
               messageContainer.appendChild(messageDiv);
           });
       } else {
           console.log("Keine Nachrichten gefunden.");
       }
   }).catch((error) => {
       console.error("Fehler beim Abrufen der Nachrichten:", error);
   });
}

</script>

</body>
</html>
